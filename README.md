# Remix + Cloudflare Pages + Prisma Accelerate Self Hosting + Local debug

## Prisma Accelerate をローカルでデバッグする場合の問題点

アプリケーションを開発する時、DB をローカル環境の Docker で建てて開発していくケースは多いと思います。しかし、Prisma Accelerate を使用する場合、基本的にはローカル環境の DB にアクセスすることができません。そのため、Prisma Accelerate を使用する場合、リモートの DB にアクセスする必要があります。これでは開発が非常に面倒なため、ローカル環境で Prisma Accelerate を Self Hosting する方法を紹介します。

## prisma-accelerate-local の使い方

ポート 8000 で http サーバーを立ち上げる場合

```sh
prisma-accelerate-local postgresql://postgres:password@localhost:5432/postgres?schema=accelerate-test -p 8000 -t
```

ローカル用なので、API キーは不要です。

## Environment Variables

- prisma.schema

```prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model Test {
  id String @id @default(uuid())
}
```

- .env

`prisma prisma migrate dev`用の設定です。`DATABASE_URL`は何が入っていても構いません。

```env
DATABASE_URL="DATABASE_URL=prisma://localhost:8000/?api_key=a"
DIRECT_DATABASE_URL="postgresql://postgres:password@localhost:5432/postgres?schema=accelerate-test"
```

- .dev.var

コードからアクセスする際の設定です。api_key は何が入っていても構いませんが、Prisma の仕様で空には出来ません。

```env
DATABASE_URL=prisma://localhost:8000/?api_key=a"
```

- commands

おおまかな流れは以下の通りです。

```sh
docker compose -f docker/docker-compose.yml up -d
npm run prisma migrate dev
npm run prisma generate --no-engine
npx prisma-accelerate-local postgresql://postgres:password@localhost:5432/postgres?schema=accelerate-test -p 8000 -t
```

## 必要なコード

https://github.com/SoraKumo001/cloudflare-remix-accelerate-local-debug

- load-context.ts

Prisma Accelerate を使用する場合、prisma が通信時のプロトコルを `https` にしてしまうため、`fetch` をフックして `http` に変更する必要があります。

```ts
import { AppLoadContext } from "@remix-run/cloudflare";
import { type PlatformProxy } from "wrangler";

type Cloudflare = Omit<PlatformProxy<Env>, "dispose"> & {
  cf: IncomingRequestCfProperties;
};

declare module "@remix-run/cloudflare" {
  interface AppLoadContext {
    cloudflare: Cloudflare;
  }
}

type GetLoadContext = (args: {
  request: Request;
  context: { cloudflare: Cloudflare };
}) => AppLoadContext;

const hookFetch = () => {
  const that = globalThis as typeof globalThis & {
    __originFetch?: typeof fetch;
  };
  if (that.__originFetch) return;
  const originFetch = globalThis.fetch;
  that.__originFetch = originFetch;

  globalThis.fetch = (async (input: RequestInfo, init?: RequestInit) => {
    const url = new URL(input.toString());
    // If the request is to localhost and is https, change it to http
    if (
      ["127.0.0.1", "localhost"].includes(url.hostname) &&
      url.protocol === "https:"
    ) {
      url.protocol = "http:";
      return originFetch(url.toString(), init);
    }
    return originFetch(input, init);
  }) as typeof fetch;
};

export const getLoadContext: GetLoadContext = ({ context }) => {
  hookFetch();
  return context;
};
```

- vite.config.ts

開発モードでデバッグする場合に getLoadContext を呼び出す設定です

```ts
import {
  vitePlugin as remix,
  cloudflareDevProxyVitePlugin as remixCloudflareDevProxy,
} from "@remix-run/dev";
import { getLoadContext } from "./load-context";
import { defineConfig } from "vite";
import tsconfigPaths from "vite-tsconfig-paths";

export default defineConfig({
  plugins: [
    remixCloudflareDevProxy({ getLoadContext }),
    remix({
      future: {
        v3_fetcherPersist: true,
        v3_relativeSplatPath: true,
        v3_throwAbortReason: true,
      },
    }),
    tsconfigPaths(),
  ],
});
```

- functions/[[path]].ts

wrangler から起動する場合に getLoadContext を呼び出す設定です

```ts
import { createPagesFunctionHandler } from "@remix-run/cloudflare-pages";

// eslint-disable-next-line @typescript-eslint/ban-ts-comment
// @ts-ignore - the server build file is generated by `remix vite:build`
// eslint-disable-next-line import/no-unresolved
import * as build from "../build/server";
import { getLoadContext } from "../load-context";

export const onRequest = createPagesFunctionHandler({
  build,
  getLoadContext,
} as never);
```

# まとめ

Cloudflare と Prisma Accelerate を組み合わせて、ローカル DB にアクセスする方法を紹介しました。この方法を使えば、開発が楽になると思います。
